!*********************!
! Prepare environment !
!*********************!

option,  warn,info;
system,"rm -rf temp";
system,"mkdir temp";

system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503 db5";
system,"ln -fns /afs/cern.ch/eng/lhc/optics/runIII lhc";
system,"ln -fns /afs/cern.ch/eng/lhc/optics/HLLHCV1.4 slhc";
system,"ln -fns /afs/cern.ch/eng/lhc/optics/errors/0705 wise";
system,"ln -fns /afs/cern.ch/work/f/fvanderv/projects/HL14errors/ fre";
system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503/WISE/After_sector_3-4_repair fidel";
option,-echo,-info;

! Beam-beam macros folder
system,"ln -fns /afs/cern.ch/eng/lhc/optics/beambeam_macros beambeam_macros"; 

!**************************!
! Configuration parameters !
!**************************!

! Define optics
system,"ln -fns slhc/round/opt_round_150_1500_thin.madx myoptics.madx";

cp_mylhcbeam = %BEAM%; ! LHC beam 1 (clockwise), LHC beam 2 (clockwise), LHC beam 2 (counterclockwise)
cp_on_collision = 1;
cp_on_bb_switch = 1;

! Settings
cp_oct_current = %OCT%;     ! [A]
cp_chromaticity = %CHROM%;
cp_xing_ang_ip15 = %XING;

! Beam parameters
cp_beam_norm_emit  = %EMIT_BEAM;  ! [m]
cp_beam_sigt  = 0.075; ! [m]
cp_beam_sige  = 1.1e-4; ! [-]
cp_beam_npart = %NPART;      ! [-]
cp_beam_energy_tot = 7000; ! [GeV]

! Integer tunes and tune split
cp_qx00   = 62.0;  
cp_qy00   = 60.0;  
cp_tsplit = 2.0;  

! Tunes with fractional part
cp_qx0 = 62.31;
cp_qy0 = 60.32;

!IP specific settings 
cp_on_x1 = cp_xing_ang_ip15;
cp_on_sep1 = -0.75;  
cp_on_x5 = cp_xing_ang_ip15;
cp_on_sep5 = 0.75;  
cp_on_x2 = 170;
cp_on_sep2 = 1;
cp_on_x8 = -200;
cp_on_sep8 = -1;
cp_on_a1 = 0;
cp_on_o1 = 0;           
cp_on_a5 = 0;
cp_on_o5 = 0;
cp_on_a2 = 0;
cp_on_o2 = 0;
cp_on_a8 = 0;
cp_on_o8 = 0;
cp_on_crab1 = -190;
cp_on_crab5 = -190;           

cp_on_alice=7000/cp_beam_energy_tot;
cp_on_lhcb =7000/cp_beam_energy_tot;

cp_on_sol_atlas=0;
cp_on_sol_cms=  0;
cp_on_sol_alice=0;

! Dispersion correction knob
cp_on_disp = 1;

! Second order chrmaticity
cp_on_qpp =0;  ! Correction of residual Q'' by MO's

!!! Errors and corrections

! Set this flag to correct the errors of D2 in the NLC (warning: for now only correcting b3 of D2, still in development)
correct_for_D2=0;
! Set this flag to correct the errors of MCBXF in the NLC (warning: this might be less reproducable in reality, use with care)
correct_for_MCBX=0;

off_all_errors=0;

cp_on_errors_LHC=1;
cp_on_errors_MBH=1;
cp_on_errors_Q5=1;
cp_on_errors_Q4=1;
cp_on_errors_D2=1;
cp_on_errors_D1=1;
cp_on_errors_IT=1;
cp_on_errors_MCBRD=1;
cp_on_errors_MCBXF=1;

! Select error table (decide if injection or collisions
cp_myseed = %SEEDRAN;
system, "ln -fns /wise/collision_errors-emfqcs-%SEEDRAN.tfs error_table.tfs" ;

! Beam-beam configuration

cp_b_t_dist = 25.;  !bunch separation [ns]

cp_n_inside_D1 = 5;    !default value for the number of additionnal parasitic encounters inside D1

cp_nho_IR1= 11;        ! number of slices for head-on in IR1 (between 0 and 201)
cp_nho_IR2= 11;        ! number of slices for head-on in IR2 (between 0 and 201)
cp_nho_IR5= 11;        ! number of slices for head-on in IR5 (between 0 and 201)
cp_nho_IR8= 11;        ! number of slices for head-on in IR8 (between 0 and 201)

cp_nco_IP1 = 2592;
cp_nco_IP5 = cp_nco_IP1;
cp_nco_IP2 = 2288;
cp_nco_IP8 = 2396;

!Leveling in IP8
cp_lumi_ip8 = 2e33; ![Hz/cm2]







!---------------------------------------------------------------;
!           CALL IN SELECTION, MACRO's, SEQUENCE, BEAM, NRJ and OPTICS FILES;
!---------------------------------------------------------------;




call, file="mask_01.mask";
call, file="mask_02.mask";
call, file="mask_03.mask";

stop;



call, file="slhc/toolkit/get_optics_params.madx";



!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
!                 final twiss before sending to sixtrack
!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

ON_BB_CHARGE:=1;

if (NRJ<4999.9999) {VRF400:=8. ;LAGRF400.B1=0.5;LAGRF400.B2=0.;};
if (NRJ>5000.0000) {VRF400:=16.;LAGRF400.B1=0.5;LAGRF400.B2=0.;};



print, text="========================================";
print, text="======  OPTICS PARAMETERS: FINAL  ======";
print, text="========================================";
call, file="slhc/toolkit/get_optics_params.madx";


call, file="slhc/toolkit/BetaBeating.madx";
twiss, chrom;
!sixtrack,cavall, mult_auto_off,radius=0.017;
sixtrack,cavall, radius=0.017;
if( ON_BB_SWITCH == 1){
  !Fix bb lenses in sixtrack input
  exec, SIXTRACK_INPUT_BB_LENSES;
}

select, flag=twiss, clear;
if (not_a_mask==1){
  twiss,file="last_twiss.1";
  System,"gzip -f last_twiss.1";
} else {
  twiss,file="last_twiss.%SEEDRAN";
  System,"gzip -f last_twiss.%SEEDRAN";
};
stop;
